# 前后端联调操作指南

## 📋 项目概述

本项目是一个基于 Node.js + WebSocket + MySQL 的实时数据展示系统：
- **后端**：Node.js 服务，定时查询 MySQL 数据库并通过 WebSocket 推送数据
- **前端**：HTML 页面，通过 WebSocket 实时接收和展示数据
- **数据库**：MySQL 8.0+，包含四张核心表

## 🛠️ 环境要求

- **Node.js**：v16+ 
- **MySQL**：8.0+
- **操作系统**：macOS/Linux/Windows

## 📁 项目结构

```
Database/
├── mysql-test2.js          # 后端服务文件
├── index-test2.html        # 前端页面文件
├── node_modules/           # Node.js 依赖包
└── package.json           # 项目配置文件
```

## 🚀 快速开始

### 1. 环境检查

```bash
# 检查 Node.js 版本
node --version

# 检查 MySQL 服务状态
mysql --version
```

### 2. 安装依赖

```bash
# 安装项目依赖
npm install express ws mysql2
```

### 3. 数据库配置

确保 MySQL 服务正常运行，并创建数据库：

```sql
-- 创建数据库
CREATE DATABASE my_database;

-- 确认四张表存在
USE my_database;
SHOW TABLES;
-- 应该看到：pt_pro_cq_type, pt_pro_tenders, sys_article, sys_organization
```

### 4. 启动服务

```bash
# 启动后端服务
node mysql-test2.js
```

**预期输出：**
```
Server running on http://localhost:3000
数据库连接成功
```

### 5. 访问前端

浏览器打开：`http://localhost:3000/index-test2.html`

## 🔧 服务管理

### 启动服务

```bash
# 前台启动（推荐用于调试）
node mysql-test2.js

# 后台启动
nohup node mysql-test2.js > server.log 2>&1 &
```

### 停止服务

```bash
# 方法1：Ctrl+C（前台运行时）
# 方法2：查找并杀死进程
ps aux | grep "node mysql-test2.js" | grep -v grep
kill [进程ID]

# 方法3：强制关闭所有相关进程
pkill -f "node mysql-test2.js"
```

### 重启服务

```bash
# 1. 停止服务
pkill -f "node mysql-test2.js"

# 2. 启动服务
node mysql-test2.js
```

### 查看服务状态

```bash
# 查看进程状态
ps aux | grep "node mysql-test2.js" | grep -v grep

# 查看端口占用
lsof -i :3000

# 查看服务日志（后台运行时）
tail -f server.log
```

## 🔍 故障排查

### 常见问题及解决方案

#### 1. 依赖缺失错误

**错误信息：**
```
Error: Cannot find module 'express'
```

**解决方案：**
```bash
npm install express ws mysql2
```

#### 2. 端口占用错误

**错误信息：**
```
Error: listen EADDRINUSE: address already in use :::3000
```

**解决方案：**
```bash
# 查找占用进程
lsof -i :3000

# 杀死占用进程
kill -9 [进程ID]
```

#### 3. MySQL 连接超时

**错误信息：**
```
Error: connect ETIMEDOUT
```

**解决方案：**
- 检查 MySQL 服务是否启动
- 确认数据库连接配置正确
- 检查防火墙设置

#### 4. MySQL 认证协议错误

**错误信息：**
```
Error: ER_NOT_SUPPORTED_AUTH_MODE
```

**解决方案：**
- 项目已使用 mysql2 库，支持 MySQL 8.0+ 认证协议
- 如仍有问题，检查 MySQL 用户权限

#### 5. 前端页面 404 错误

**错误信息：**
```
localhost/:1 Failed to load resource: the server responded with a status of 404
```

**解决方案：**
- 确认后端服务已启动
- 检查端口是否被占用
- 确认访问地址正确：`http://localhost:3000/index-test2.html`

#### 6. 数据库查询无数据

**检查步骤：**
1. 确认数据库连接成功
2. 检查表是否有数据：
   ```sql
   SELECT COUNT(*) FROM sys_article;
   SELECT COUNT(*) FROM pt_pro_cq_type;
   SELECT COUNT(*) FROM pt_pro_tenders;
   SELECT COUNT(*) FROM sys_organization;
   ```
3. 检查 SQL 查询条件是否匹配

## 📊 监控和日志

### 服务日志说明

启动服务后，终端会显示以下日志：

```
Server running on http://localhost:3000    # 服务启动成功
数据库连接成功                              # 数据库连接成功
Client connected                            # 前端连接成功
SQL查询成功，返回记录数: 142                 # 数据查询成功
Client disconnected                         # 前端断开连接
```

### 性能监控

```bash
# 查看 CPU 和内存使用
top -p $(pgrep -f "node mysql-test2.js")

# 查看网络连接
netstat -an | grep :3000
```

## 🔧 配置说明

### 数据库配置

在 `mysql-test2.js` 中修改数据库连接配置：

```javascript
const db = mysql.createConnection({
    host: 'localhost',           // 数据库主机
    user: 'root',               // 用户名
    password: 'Root@123456',    // 密码
    database: 'my_database'     // 数据库名
});
```

### 服务端口配置

修改服务端口（默认 3000）：

```javascript
const port = 3000;  // 修改为其他端口
```

### 数据推送频率

修改数据推送间隔（默认 5 秒）：

```javascript
setInterval(() => {
    // 查询逻辑
}, 5000);  // 修改为其他毫秒数
```

## 📈 数据说明

### 数据库表结构

- **sys_article**：系统文章表，包含成交公示信息
- **pt_pro_cq_type**：项目成交类型表
- **pt_pro_tenders**：项目投标表
- **sys_organization**：系统组织表

### 查询逻辑

SQL 查询按以下条件筛选数据：
- 文章标题包含"成交公示"
- 按行政区划码和项目类别分组
- 计算成交金额和成交笔数

## 🚨 注意事项

1. **数据库安全**：生产环境请使用强密码和专用数据库用户
2. **端口安全**：避免使用默认端口，配置防火墙规则
3. **日志管理**：定期清理日志文件，避免磁盘空间不足
4. **备份策略**：定期备份数据库和代码文件
5. **性能优化**：大数据量时考虑分页查询和缓存机制

## 📞 技术支持

如遇到问题，请按以下步骤排查：

1. 查看终端错误信息
2. 检查数据库连接状态
3. 确认依赖包版本兼容性
4. 查看系统资源使用情况
5. 检查网络连接状态

---

**最后更新**：2024年12月
**版本**：v1.0 